# Optimized: compress built libraries into a single archive per job (tar.gz on Linux/macOS/Android/iOS, .zip on Windows)
# and upload that single archive as the artifact (smaller, fewer files, more robust).
# combine-libs updated to extract archives before moving files.
# retention-days added to uploads.
# Other upload robustness improvements: explicit archive existence checks and clearer debug output.
#
# Trigger: manual workflow_dispatch
name: Build Luau Libraries

on: workflow_dispatch

# Grant write permissions to GITHUB_TOKEN so the workflow can push commits
permissions:
  contents: write

jobs:
  build-libs:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            arch: x64
            lib_name: libluau.a
          - os: ubuntu-latest
            platform: Linux
            arch: arm64
            lib_name: libluau.a
          - os: windows-latest
            platform: Windows
            arch: x64
            lib_name: luau.lib
            msvc_arch: x64
          - os: windows-latest
            platform: Windows
            arch: arm64
            lib_name: luau.lib
            msvc_arch: amd64_arm64
          - os: macos-latest
            platform: MacOS
            arch: x64
            lib_name: libluau.a
          - os: macos-latest
            platform: MacOS
            arch: arm64
            lib_name: libluau.a

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: true
          lfs: false

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.22.x'

      - name: Setup Ninja (Linux/macOS)
        if: matrix.os != 'windows-latest'
        uses: ashutoshvarma/setup-ninja@v1.1
        with:
          version: 1.11.1

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Clone Luau repository
        run: |
          # Remove existing incomplete Luau source
          rm -rf project/luau || true

          # Clone official Luau repository
          git clone https://github.com/luau-lang/luau.git project/luau
        shell: bash

      - name: Build Luau library (Linux/macOS)
        if: matrix.platform == 'Linux' || matrix.platform == 'MacOS'
        run: |
          # Navigate to Luau source directory
          cd project/luau

          # Build with CMake for the specific platform/arch
          mkdir -p build
          cd build

          if [ "${{ matrix.platform }}" = "MacOS" ]; then
            # macOS: choose architecture via CMAKE_OSX_ARCHITECTURES
            # Add CoreFoundation framework to linker flags to resolve CFBundle* symbols on Apple platforms.
            if [ "${{ matrix.arch }}" = "x64" ]; then
              cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_OSX_ARCHITECTURES=x86_64 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF -DLUAU_ENABLE_CODEGEN=ON -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
            else
              cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_OSX_ARCHITECTURES=arm64 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF -DLUAU_ENABLE_CODEGEN=ON -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
            fi
          else
            # Linux: use Ninja; install cross toolchain if arm64
            if [ "${{ matrix.arch }}" = "arm64" ]; then
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
              cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=MinSizeRel -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF \
                -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
                -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
                -DCMAKE_AR=/usr/bin/aarch64-linux-gnu-ar \
                -DCMAKE_RANLIB=/usr/bin/aarch64-linux-gnu-ranlib \
                -DLUAU_ENABLE_CODEGEN=ON
            else
              cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=MinSizeRel -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF -DLUAU_ENABLE_CODEGEN=ON
            fi
          fi

          cmake --build . --config MinSizeRel

          # Combine MINIMAL static archives into a single static library (Ast/Compiler/Config/VM/CodeGen)
          echo "Listing minimal libLuau.*.a recursively:"
          find . -name 'libLuau.Ast.a' -type f -print || true
          find . -name 'libLuau.Compiler.a' -type f -print || true
          find . -name 'libLuau.Config.a' -type f -print || true
          find . -name 'libLuau.VM.a' -type f -print || true
          find . -name 'libLuau.CodeGen.a' -type f -print || true

          if [ "${{ matrix.platform }}" = "MacOS" ]; then
            libs=$( (find . -name 'libLuau.Ast.a' -type f; find . -name 'libLuau.Compiler.a' -type f; find . -name 'libLuau.Config.a' -type f; find . -name 'libLuau.VM.a' -type f; find . -name 'libLuau.CodeGen.a' -type f) | tr '\n' ' ' )
            if [ -z "$libs" ]; then
              echo "No minimal libLuau.*.a found"; exit 1
            fi
            libtool -static -o libluau.a $libs
            ranlib libluau.a
          else
            # Choose appropriate ar/ranlib for arch
            if [ "${{ matrix.arch }}" = "arm64" ]; then
              AR_BIN=aarch64-linux-gnu-ar
              RANLIB_BIN=aarch64-linux-gnu-ranlib
            else
              AR_BIN=ar
              RANLIB_BIN=ranlib
            fi
            echo "create libluau.a" > combine.mri
            find . -name 'libLuau.Ast.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
            find . -name 'libLuau.Compiler.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
            find . -name 'libLuau.Config.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
            find . -name 'libLuau.VM.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
            find . -name 'libLuau.CodeGen.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
            echo "save" >> combine.mri
            echo "end" >> combine.mri
            $AR_BIN -M < combine.mri
            $RANLIB_BIN libluau.a
          fi

          # Copy to built_lib
          mkdir -p ../built_lib
          cp libluau.a ../built_lib/libluau.a || true

          # Archive built_lib to a single tar.gz for upload
          mkdir -p ../archives
          if [ -d ../built_lib ] && [ "$(ls -A ../built_lib || true)" ]; then
            tar -C ../built_lib -czf ../archives/luau-libs-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz .
            echo "Created archive: ../archives/luau-libs-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz"
            ls -la ../archives
          else
            echo "ERROR: built_lib empty or missing"; ls -la .. || true; exit 1
          fi
        shell: bash

      - name: Validate Unix library (Linux/macOS)
        if: matrix.platform == 'Linux' || matrix.platform == 'MacOS'
        run: |
          set -e
          cd project/luau/built_lib
          if [ ! -f "libluau.a" ]; then
            echo "ERROR: libluau.a not found after build"
            ls -la
            exit 1
          fi
          # Basic validation: ar can list members
          ar -t libluau.a > /dev/null || { echo "ERROR: 'ar' failed to read libluau.a"; exit 1; }
          # Optional: print file type for debugging
          command -v file >/dev/null 2>&1 && file -b libluau.a || true
        shell: bash
        
      - name: Build Luau library (Windows)
        if: matrix.platform == 'Windows'
        run: |
            REM Remove existing incomplete Luau source
            rmdir /s /q project\luau 2>nul || exit /b 0
        
            REM Clone official Luau repository
            git clone https://github.com/luau-lang/luau.git project\luau
        
            REM Navigate to Luau source directory
            cd project\luau
        
            REM Build with CMake using Ninja generator
            mkdir build
            cd build
            cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded -DLUAU_ENABLE_CODEGEN=ON
            cmake --build . --config MinSizeRel
        
            REM Combine minimal set of Luau libraries (Ast/Compiler/Config/VM/CodeGen)
            echo Listing candidate Luau.*.lib in current build dir:
            dir /b Luau.Ast.lib Luau.Compiler.lib Luau.Config.lib Luau.VM.lib Luau.CodeGen.lib 2>nul
        
            setlocal EnableDelayedExpansion
            set FILES=
            rem Prefer libs in current build dir (Ninja single-config)
            for %%f in (Luau.Ast.lib Luau.Compiler.lib Luau.Config.lib Luau.VM.lib Luau.CodeGen.lib) do (
              if exist "%%f" set FILES=!FILES! "%%f"
            )
        
            rem Fallback: recursive search, excluding CMakeFiles (to avoid bogus paths)
            if "!FILES!"=="" (
              echo No libs found in current dir; searching recursively...
              for /r %%f in (Luau.Ast.lib) do (
                echo %%f | findstr /i /c:"\CMakeFiles\" >nul || set FILES=!FILES! "%%f"
              )
              for /r %%f in (Luau.Compiler.lib) do (
                echo %%f | findstr /i /c:"\CMakeFiles\" >nul || set FILES=!FILES! "%%f"
              )
              for /r %%f in (Luau.Config.lib) do (
                echo %%f | findstr /i /c:"\CMakeFiles\" >nul || set FILES=!FILES! "%%f"
              )
              for /r %%f in (Luau.VM.lib) do (
                echo %%f | findstr /i /c:"\CMakeFiles\" >nul || set FILES=!FILES! "%%f"
              )
              for /r %%f in (Luau.CodeGen.lib) do (
                echo %%f | findstr /i /c:"\CMakeFiles\" >nul || set FILES=!FILES! "%%f"
              )
            )
            if "!FILES!"=="" (
              echo No .lib files found to merge. Failing.
              exit /b 1
            )
            echo Merging libs:
            echo !FILES!
            lib.exe /OUT:luau.lib !FILES!
            if errorlevel 1 exit /b %errorlevel%
        
            REM Copy to built_lib
            mkdir ..\built_lib 2>nul || exit /b 0
            copy /Y luau.lib ..\built_lib\luau.lib
        
            REM Debug: Check built_lib contents
            echo Checking built_lib contents:
            dir ..\built_lib
        
            REM Create archives directory if missing (use relative path from build\ => ..\archives)
            powershell -Command "New-Item -ItemType Directory -Path '..\\archives' -Force"
        
            REM Archive built_lib into a single zip for upload (use ..\built_lib and ..\archives)
            powershell -Command ^
              "if ((Test-Path '..\\built_lib') -and (Get-ChildItem '..\\built_lib' -File)) {" ^
              "  Compress-Archive -Path '..\\built_lib\\*' -DestinationPath '..\\archives\\luau-libs-${{ matrix.platform }}-${{ matrix.arch }}.zip' -Force" ^
              "} else {" ^
              "  Write-Error 'built_lib missing or empty'; exit 1" ^
              "}"
        
            REM Debug
            echo Files in archives directory:
            dir ..\archives\
        shell: cmd

      - name: Validate Windows library (luau.lib)
        if: matrix.platform == 'Windows'
        shell: cmd
        run: |
          setlocal EnableDelayedExpansion
          cd project\luau\built_lib
          if not exist "luau.lib" (
            echo ERROR: luau.lib not found after build
            dir
            exit /b 1
          )
          rem Authoritative validation: lib.exe can list members
          lib.exe /NOLOGO /LIST "luau.lib" >nul 2>&1
          if errorlevel 1 (
            echo ERROR: lib.exe failed to read luau.lib; invalid or corrupt.
            exit /b 1
          )
          rem Optional: dumpbin headers if available
          where dumpbin >nul 2>&1 && dumpbin /headers "luau.lib" >nul 2>&1

      - name: Upload built libraries (single archive)
        uses: actions/upload-artifact@v4
        with:
          name: luau-libs-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            project/luau/archives/luau-libs-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz
            project/luau/archives/luau-libs-${{ matrix.platform }}-${{ matrix.arch }}.zip
          if-no-files-found: error
          retention-days: 7

  build-android-libs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            android_abi: arm64-v8a
            lib_name: libluau-arm64.a
          - arch: x64
            android_abi: x86_64
            lib_name: libluau-x86_64.a
          - arch: armv7a
            android_abi: armeabi-v7a
            lib_name: libluau-armv7a.a
          - arch: x86
            android_abi: x86
            lib_name: libluau-x86.a
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.22.x'

      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@v1.1
        with:
          version: 1.11.1

      - name: Setup Android SDK/NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          ndk: 25.1.8937393

      - name: Clone Luau repository
        run: |
          rm -rf project/luau || true
          git clone https://github.com/luau-lang/luau.git project/luau
        shell: bash

      - name: Build Luau library (Android)
        run: |
          cd project/luau
          mkdir -p build
          cd build

          # Resolve NDK path variable name
          if [ -n "$ANDROID_NDK_ROOT" ]; then NDK="$ANDROID_NDK_ROOT"; else NDK="$ANDROID_NDK_HOME"; fi

          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="${{ matrix.android_abi }}" \
            -DANDROID_PLATFORM=android-21 \
            -DANDROID_STL=c++_static \
            -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF

          cmake --build . --config MinSizeRel

          # Combine MINIMAL Luau libraries into one output per ABI (Ast/Compiler/Config/VM)
          echo "Listing minimal libLuau.*.a recursively:"
          find . -name 'libLuau.Ast.a' -type f -print || true
          find . -name 'libLuau.Compiler.a' -type f -print || true
          find . -name 'libLuau.Config.a' -type f -print || true
          find . -name 'libLuau.VM.a' -type f -print || true
          echo "create ${{ matrix.lib_name }}" > combine.mri
          find . -name 'libLuau.Ast.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
          find . -name 'libLuau.Compiler.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
          find . -name 'libLuau.Config.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
          find . -name 'libLuau.VM.a' -type f -print0 | xargs -0 -I{} echo "addlib {}" >> combine.mri
          echo "save" >> combine.mri
          echo "end" >> combine.mri
          ar -M < combine.mri
          ranlib "${{ matrix.lib_name }}" || true

          mkdir -p ../built_lib
          cp "${{ matrix.lib_name }}" ../built_lib/ || true
          ls -la ../built_lib/

          # Archive for upload
          mkdir -p ../archives
          if [ -d ../built_lib ] && [ "$(ls -A ../built_lib || true)" ]; then
            tar -C ../built_lib -czf ../archives/luau-libs-Android-${{ matrix.arch }}.tar.gz .
            echo "Created archive: ../archives/luau-libs-Android-${{ matrix.arch }}.tar.gz"
            ls -la ../archives
          else
            echo "ERROR: built_lib empty or missing"; ls -la .. || true; exit 1
          fi
        shell: bash

      - name: Upload built libraries
        uses: actions/upload-artifact@v4
        with:
          name: luau-libs-Android-${{ matrix.arch }}
          path: project/luau/archives/luau-libs-Android-${{ matrix.arch }}.tar.gz
          if-no-files-found: error
          retention-days: 7

  build-ios-libs:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            sdk: iphoneos
            lib_name: libluau_device.a
          - arch: x64
            sdk: iphonesimulator
            lib_name: libluau_sim.a
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.22.x'

      - name: Clone Luau repository
        run: |
          rm -rf project/luau || true
          git clone https://github.com/luau-lang/luau.git project/luau
        shell: bash

      - name: Build Luau library (iOS)
        run: |
          cd project/luau
          mkdir -p build
          cd build

          if [ "${{ matrix.arch }}" = "x64" ]; then
            # Add CoreFoundation framework to linker flags to resolve CFBundle* when building tests/CLI for simulator
            cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF -DLUAU_ENABLE_CODEGEN=ON -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
          else
            cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=${{ matrix.sdk }} -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 -DBUILD_TESTING=OFF -DLUAU_BUILD_TESTS=OFF -DLUAU_BUILD_CLI=OFF -DLUAU_ENABLE_CODEGEN=ON -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
          fi

          cmake --build . --config MinSizeRel

          # Combine MINIMAL Luau libraries (Ast/Compiler/Config/VM/CodeGen)
          libs=$( (find . -name 'libLuau.Ast.a' -type f; find . -name 'libLuau.Compiler.a' -type f; find . -name 'libLuau.Config.a' -type f; find . -name 'libLuau.VM.a' -type f; find . -name 'libLuau.CodeGen.a' -type f) | tr '\n' ' ' )
          if [ -z "$libs" ]; then
            echo "No minimal libLuau.*.a found"; exit 1
          fi
          libtool -static -o "${{ matrix.lib_name }}" $libs
          ranlib "${{ matrix.lib_name }}"

          mkdir -p ../built_lib
          cp "${{ matrix.lib_name }}" ../built_lib/ || true
          ls -la ../built_lib/

          # Archive built_lib
          mkdir -p ../archives
          if [ -d ../built_lib ] && [ "$(ls -A ../built_lib || true)" ]; then
            tar -C ../built_lib -czf ../archives/luau-libs-iOS-${{ matrix.arch }}.tar.gz .
            echo "Created archive: ../archives/luau-libs-iOS-${{ matrix.arch }}.tar.gz"
            ls -la ../archives
          else
            echo "ERROR: built_lib empty or missing"; ls -la .. || true; exit 1
          fi
        shell: bash

      - name: Upload built libraries
        uses: actions/upload-artifact@v4
        with:
          name: luau-libs-iOS-${{ matrix.arch }}
          path: project/luau/archives/luau-libs-iOS-${{ matrix.arch }}.tar.gz
          if-no-files-found: error
          retention-days: 7

  combine-libs:
    needs: [build-libs, build-android-libs, build-ios-libs]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false
          persist-credentials: true

      # Using GITHUB_TOKEN via checkout's persisted credentials for HTTPS push

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create lib directories
        run: |
          mkdir -p project/luau/lib/Linux/x64
          mkdir -p project/luau/lib/Linux/arm64
          mkdir -p project/luau/lib/Windows/x64
          mkdir -p project/luau/lib/Windows/arm64
          mkdir -p project/luau/lib/MacOS/x64
          mkdir -p project/luau/lib/MacOS/arm64
          mkdir -p project/luau/lib/Android
          mkdir -p project/luau/lib/iOS

      - name: Extract artifact archives (tar.gz / zip) into their artifact folders
        shell: bash
        run: |
          shopt -s nullglob
          for d in luau-libs-* ; do
            if [ -d "$d" ]; then
              echo "Processing artifact folder: $d"
              for a in "$d"/*; do
                case "$a" in
                  *.tar.gz) echo "Extracting $a"; tar -xzf "$a" -C "$d" ;;
                  *.zip) echo "Unzipping $a"; unzip -q "$a" -d "$d" ;;
                  *) echo "Skipping non-archive file $a" ;;
                esac
              done
              echo "Contents of $d after extraction:"
              ls -la "$d" || true
            fi
          done

      - name: Move extracted files to correct locations
        run: |
          # Linux x64
          if [ -d "luau-libs-Linux-x64" ] && [ -f "luau-libs-Linux-x64/libluau.a" ]; then
            mv luau-libs-Linux-x64/libluau.a project/luau/lib/Linux/x64/libluau.a
            echo "Moved Linux x64 library"
          else
            echo "No Linux x64 library found"
          fi
          # Linux arm64
          if [ -d "luau-libs-Linux-arm64" ] && [ -f "luau-libs-Linux-arm64/libluau.a" ]; then
            mv luau-libs-Linux-arm64/libluau.a project/luau/lib/Linux/arm64/libluau.a
            echo "Moved Linux arm64 library"
          else
            echo "No Linux arm64 library found"
          fi

          # Windows x64
          if [ -d "luau-libs-Windows-x64" ] && [ -f "luau-libs-Windows-x64/luau.lib" ]; then
            mv luau-libs-Windows-x64/luau.lib project/luau/lib/Windows/x64/luau.lib
            echo "Moved Windows x64 library"
          else
            echo "No Windows x64 library found"
          fi
          # Windows arm64
          if [ -d "luau-libs-Windows-arm64" ] && [ -f "luau-libs-Windows-arm64/luau.lib" ]; then
            mv luau-libs-Windows-arm64/luau.lib project/luau/lib/Windows/arm64/luau.lib
            echo "Moved Windows arm64 library"
          else
            echo "No Windows arm64 library found"
          fi

          # MacOS x64
          if [ -d "luau-libs-MacOS-x64" ] && [ -f "luau-libs-MacOS-x64/libluau.a" ]; then
            mv luau-libs-MacOS-x64/libluau.a project/luau/lib/MacOS/x64/libluau.a
            echo "Moved MacOS x64 library"
          else
            echo "No MacOS x64 library found"
          fi
          # MacOS arm64
          if [ -d "luau-libs-MacOS-arm64" ] && [ -f "luau-libs-MacOS-arm64/libluau.a" ]; then
            mv luau-libs-MacOS-arm64/libluau.a project/luau/lib/MacOS/arm64/libluau.a
            echo "Moved MacOS arm64 library"
          else
            echo "No MacOS arm64 library found"
          fi

          # Android arm64/x64
          if [ -d "luau-libs-Android-arm64" ] && [ -f "luau-libs-Android-arm64/libluau-arm64.a" ]; then
            mv luau-libs-Android-arm64/libluau-arm64.a project/luau/lib/Android/libluau-arm64.a
            echo "Moved Android arm64 library"
          else
            echo "No Android arm64 library found"
          fi
          if [ -d "luau-libs-Android-x64" ] && [ -f "luau-libs-Android-x64/libluau-x86_64.a" ]; then
            mv luau-libs-Android-x64/libluau-x86_64.a project/luau/lib/Android/libluau-x86_64.a
            echo "Moved Android x64 library"
          else
            echo "No Android x64 library found"
          fi
          # Android armv7a/x86 (32-bit)
          if [ -d "luau-libs-Android-armv7a" ] && [ -f "luau-libs-Android-armv7a/libluau-armv7a.a" ]; then
            mv luau-libs-Android-armv7a/libluau-armv7a.a project/luau/lib/Android/libluau-armv7a.a
            echo "Moved Android armv7a library"
          else
            echo "No Android armv7a library found"
          fi
          if [ -d "luau-libs-Android-x86" ] && [ -f "luau-libs-Android-x86/libluau-x86.a" ]; then
            mv luau-libs-Android-x86/libluau-x86.a project/luau/lib/Android/libluau-x86.a
            echo "Moved Android x86 library"
          else
            echo "No Android x86 library found"
          fi

          # iOS arm64/x64
          if [ -d "luau-libs-iOS-arm64" ] && [ -f "luau-libs-iOS-arm64/libluau_device.a" ]; then
            mv luau-libs-iOS-arm64/libluau_device.a project/luau/lib/iOS/libluau_device.a
            echo "Moved iOS device (arm64) library"
          else
            echo "No iOS arm64 library found"
          fi
          if [ -d "luau-libs-iOS-x64" ] && [ -f "luau-libs-iOS-x64/libluau_sim.a" ]; then
            mv luau-libs-iOS-x64/libluau_sim.a project/luau/lib/iOS/libluau_sim.a
            echo "Moved iOS simulator (x64) library"
          else
            echo "No iOS x64 library found"
          fi

      - name: Create GitHub release and upload libraries (supports large files)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          TAG="prebuilt-luau-${{ github.run_id }}"
          BODY="Prebuilt Luau libraries for run ${{ github.run_id }} (workflow ${{ github.workflow }})"
          echo "Creating release $TAG in $REPO"

          # Ensure jq is available (used to construct/parse JSON and to url-encode asset names)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          # Create a release via the GitHub API (will create the tag if it doesn't exist)
          create_resp=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$REPO/releases -d "$(jq -n --arg tag "$TAG" --arg name "$TAG" --arg body "$BODY" '{ tag_name: $tag, name: $name, body: $body, draft: false, prerelease: false }')")
          upload_url=$(echo "$create_resp" | jq -r .upload_url | sed -e "s/{?name,label}//")
          release_id=$(echo "$create_resp" | jq -r .id)

          if [ -z "$upload_url" ] || [ "$upload_url" = "null" ]; then
            echo "Failed to create release. Response:"
            echo "$create_resp"
            exit 1
          fi
          echo "Release upload URL: $upload_url (release id: $release_id)"

          # Upload every file under project/luau/lib as a release asset (handles large files)
          shopt -s globstar nullglob
          files=(project/luau/lib/**/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files found under project/luau/lib to upload. Exiting."
            exit 1
          fi

          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              # Create a unique asset name based on path under project/luau/lib, e.g. Linux-x64-libluau.a
              rel="${f#project/luau/lib/}"
              asset_name="${rel//\//-}"   # replace slashes with dashes so names are unique and human-readable
              echo "Preparing upload: $f -> asset name: $asset_name"

              # If an asset with the same name already exists in the release, delete it first.
              existing_id=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/releases/$release_id/assets" | jq -r --arg name "$asset_name" '.[] | select(.name == $name) | .id' || true)
              if [ -n "$existing_id" ] && [ "$existing_id" != "null" ]; then
                echo "Existing asset with same name found (id=$existing_id). Deleting before upload."
                curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/releases/assets/$existing_id" || true
                echo "Deleted existing asset id $existing_id."
              fi

              # URL-encode the asset name for the upload URL
              encoded_name=$(jq -rn --arg n "$asset_name" '$n|@uri')

              # Retry upload with exponential backoff
              max_attempts=5
              attempt=0
              success=0
              while [ $attempt -lt $max_attempts ]; do
                attempt=$((attempt+1))
                echo "Uploading $f as $asset_name (attempt $attempt/$max_attempts)..."
                http_status=$(curl -s -w "%{http_code}" -o /tmp/upload_resp -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/octet-stream" --data-binary @"$f" "$upload_url?name=$encoded_name" || true)
                if [ "$http_status" = "201" ]; then
                  echo "Upload succeeded for $asset_name."
                  success=1
                  break
                else
                  echo "Upload attempt $attempt failed with HTTP $http_status. Response:"
                  sed -n '1,200p' /tmp/upload_resp || true
                  sleep $(( attempt * 2 ))
                fi
              done

              if [ $success -ne 1 ]; then
                echo "Upload failed for $f after $max_attempts attempts. Aborting."
                exit 1
              fi
            fi
          done

          echo "All assets uploaded to release $TAG."
