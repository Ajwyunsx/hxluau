name: Build Luau Libraries

on:
  workflow_dispatch:
    inputs:
      luau_branch:
        description: 'Luau branch/tag to build'
        required: false
        default: 'main'
        type: string

# Grant write permissions to GITHUB_TOKEN so the workflow can push commits
permissions:
  contents: write

env:
  CMAKE_VERSION: '3.28.x'  # Updated to newer version
  NINJA_VERSION: '1.12.1'  # Updated to latest
  NDK_VERSION: '25.1.8937393'
  LUAU_REPO: 'https://github.com/luau-lang/luau.git'

jobs:
  build-libs:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - { os: ubuntu-latest, platform: Linux, arch: x64, lib_name: libluau.a }
          - { os: ubuntu-latest, platform: Linux, arch: arm64, lib_name: libluau.a }
          - { os: windows-latest, platform: Windows, arch: x64, lib_name: luau.lib, msvc_arch: x64 }
          - { os: windows-latest, platform: Windows, arch: arm64, lib_name: luau.lib, msvc_arch: amd64_arm64 }
          - { os: macos-latest, platform: MacOS, arch: x64, lib_name: libluau.a }
          - { os: macos-latest, platform: MacOS, arch: arm64, lib_name: libluau.a }

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: false

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2  # Updated to v2
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Setup Ninja (Unix)
        if: matrix.platform != 'Windows'
        uses: ashutoshvarma/setup-ninja@v2  # Updated to v2
        with:
          version: ${{ env.NINJA_VERSION }}

      - name: Verify Ninja installation
        if: matrix.platform != 'Windows'
        run: |
          ninja --version
          which ninja
          echo "Ninja is available at: $(which ninja)"
          echo "PATH=$PATH"
        shell: bash

      - name: Setup MSVC (Windows)
        if: matrix.platform == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Clone Luau repository
        run: |
          # Cache-friendly clone with shallow depth
          if [[ -d "project/luau/.git" ]]; then
            cd project/luau
            git fetch origin ${{ github.event.inputs.luau_branch || 'master' }} --depth 1
            git reset --hard FETCH_HEAD
          else
            mkdir -p project
            git clone --depth 1 --branch ${{ github.event.inputs.luau_branch || 'master' }} \
              ${{ env.LUAU_REPO }} project/luau
          fi
        shell: bash

      - name: Build and package library
        env:
          ARCH: ${{ matrix.arch }}
          PLATFORM: ${{ matrix.platform }}
        run: |
          cd project/luau
          ./.github/scripts/build_and_package.sh
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luau-libs-${{ matrix.platform }}-${{ matrix.arch }}
          path: project/luau/built_lib/${{ matrix.lib_name }}
          retention-days: 1
          if-no-files-found: error
